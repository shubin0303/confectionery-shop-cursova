name: Telegram Bot Runner

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *'

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm install
      
    - name: üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ngrok (–¥–ª—è —Ç—É–Ω–Ω–µ–ª—è)
      run: |
        wget -q https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
        unzip -o ngrok-stable-linux-amd64.zip
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
    - name: ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ —Ç—É–Ω–Ω–µ–ª—è
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç –≤ —Ñ–æ–Ω–µ
        node bot.js &
        BOT_PID=$!
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º ngrok —Ç—É–Ω–Ω–µ–ª—å
        ./ngrok http 3000 > /dev/null &
        NGROK_PID=$!
        
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ ngrok
        sleep 5
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        
        if [ -z "$NGROK_URL" ] || [ "$NGROK_URL" = "null" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ngrok URL"
          exit 1
        fi
        
        echo "‚úÖ Ngrok —Ç—É–Ω–Ω–µ–ª—å: $NGROK_URL"
        echo "üåê –í–µ–±—Ö—É–∫ URL: $NGROK_URL/bot${{ secrets.TELEGRAM_BOT_TOKEN }}"
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        wait $BOT_PID
        
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
